<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="a311.college.mapper.user.UserMapper">
    <update id="update">
        update tb_user
        <set>
            <if test="username != null and username !=''">
                username = #{username},
            </if>
            <if test="head != null">
                head = #{head},
            </if>
            <if test="year != null">
                year = #{year},
            </if>
            <if test="province != null">
                province = #{province},
            </if>
            <if test="subjects != null">
                subjects = #{subjects},
            </if>
            <if test="grade != null">
                grade = #{grade},
            </if>
            <if test="ranking != null">
                ranking = #{ranking},
            </if>
        </set>
        where id = #{id}
    </update>

    <!-- 优化后的主查询SQL -->
    <select id="selectVolunteerSchool" resultMap="schoolVolunteerMap">
        SELECT s.school_id,
               s.school_name,
               s.school_province,
               sc.major_name,
               sc.first_choice,
               sc.other_choice,
               sc.special,
               y.year,
               sc.min_score,
               sc.min_ranking
        FROM tb_school s
                 JOIN tb_province p ON s.school_id = p.school_id
                 JOIN tb_year y ON p.province_id = y.province_id -- 省份与年份关联
                 JOIN tb_category c ON y.year_id = c.year_id
                 JOIN tb_batch b ON c.category_id = b.category_id
                 JOIN tb_score sc ON b.batch_id = sc.batch_id
        WHERE sc.first_choice = #{firstChoice}
          AND p.province_name = #{province}
          AND sc.min_ranking between #{ranking} - 15000 and #{ranking} + 15000
        ORDER BY s.score DESC
    </select>

    <!-- 结果映射 -->
    <resultMap id="schoolVolunteerMap" type="a311.college.vo.volunteer.SchoolVolunteer">
        <id property="schoolId" column="school_id"/>
        <result property="schoolName" column="school_name"/>
        <result property="schoolProvince" column="school_province"/>
        <collection property="volunteerList" ofType="a311.college.vo.volunteer.Volunteer">
            <id property="majorName" column="major_name"/>
            <result property="firstChoice" column="first_choice"/>
            <result property="otherChoice" column="other_choice"/>
            <result property="special" column="special"/>
            <collection property="scoreLineList" ofType="a311.college.vo.volunteer.ScoreLine">
                <result property="year" column="year"/>
                <result property="minScore" column="min_score"/>
                <result property="minRanking" column="min_ranking"/>
            </collection>
        </collection>
    </resultMap>
</mapper>